#!/bin/bash
FECHA=$(date +%y%m%d%H%m)
echo "A continuación solicitaremos algunos parámetros q se necesitan para la instalación"
read -p  "Ingrese el path donde vamos a instalar el sistema, por defecto será /var/www/MatFel :" PATH_INSTALL
if [ -z $PATH_INSTALL ]
	then
		PATH_INSTALL="/var/www/MatFel"
	fi
echo "Necesitamos un nombre para la base de datos, por defecto ser MatFel."
read -p  "Ingrese el host donde estará la base de datos, por defecto será localhost :" HOST_BASE
if [ -z $HOST_BASE ]
	then
		HOST_BASE="localhost"
	fi
echo "Necesitamos un nombre para la base de datos, por defecto ser MatFel."
read -p "Ingrese el nombre de la base:" BASE
if [ -z $BASE ]
	then
		BASE="MatFel"
	fi
OK=0
while [ $OK -ne 1 ]
do
	echo "Necesitamos un usuario con privilegios para crear la base de datos, por defecto ser root"
	read -p "Ingrese el usuario privilegiado:" USER
	if [ -z $USER ]
	then
		USER="root"
	fi
	stty -echo
	echo "Necesitamos un password para acceder a la base con el usuario $USER."
	read -p "Ingrese el password para $USER:" PASSWORD
	stty echo
	
	mysql -u $USER --password=$PASSWORD -e exit
	ESTADO=$?
	if [ $ESTADO -ne 0 ]
	then
		if [ $ESTADO -eq 127 ]
		then
			echo 'No esta instalado mysql-client'
			exit
		fi
		echo "No fue posible conecatarse a la base de datos con los datos suministrados. Verifique el error puede ocurrir que falte el servidor no este disponible o el usuario no sea válido"
	else
		OK=1
	fi
done
echo "Necesitamos un usuario para que la aplicación se conecte a la base de datos la base de datos, por defecto ser UserMatFel."
read -p "Ingrese el nombre del usuario para conectarse a la base:" USUARIOBASE
if [ -z $USUARIOBASE ]
	then
		USUARIOBASE="UserMatFel"
	fi
USUARIOPASSTEMP=$(< /dev/urandom tr -dc A-Za-z0-9_ | head -c8)
echo "Necesitamos una pass para que $USUARIOBASE se conecte a la base de datos, por defecto ser $USUARIOPASSTEMP."
stty -echo
read -p "Ingrese la pass de $USUARIOBASE:" USUARIOPASS
stty echo
if [ -z $USUARIOPASS ]
	then
		USUARIOPASS=$USUARIOPASSTEMP
	fi


#################Bajar el arbol
if [ -d $PATH_INSTALL ]
	then
		echo "Hay una instalacion previa"
		mv $PATH_INSTALL $PATH_INSTALL$FECHA
	fi
mkdir -p $PATH_INSTALL

git --version
GIT_IS_AVAILABLE=$?
if [ $GIT_IS_AVAILABLE -eq 0 ]; then
	git clone https://github.com/einar-lanfranco/MatFel.git  $PATH_INSTALL
	cd $PATH_INSTALL/docs/instalador
	bash instalaraplicaciones.sh $PATH_INSTALL $USER $PASSWORD $HOST_BASE $BASE $USUARIOPASS $USUARIOBASE
	cd $OLDPWD
else
	echo "Imposible obtener el código, no esta instalado git, instalalo y reintenta"
fi

###KNOWN BUGS
## No considera que no exista Mysql-client, tampoco que no exista mysql-server si es localhost o tampoco instala git automáticamente entonces ni bien arranca falla el script    

